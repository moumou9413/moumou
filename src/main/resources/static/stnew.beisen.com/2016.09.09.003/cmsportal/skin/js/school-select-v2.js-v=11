(function($,_){var w=this;function SchoolSelector(options,schoolData,hoster){this.pData={};this.hoster=hoster;this.pData.options=options||{};this.dfSearch="请输入要查询的学校名称或学校关键字！";return this.init()}SchoolSelector.prototype={init:function(){this.$el=$(this.templateBox({}));this.$provCtt=this.$el.find(".prov_box");this.$schCtt=this.$el.find(".school_box");this.winTop=w===window&&window.top,this.topBody=$(this.winTop.document.getElementsByTagName("body"));this.pData.options.denyManualAdd===true&&this.displayManualAdd();this.bindEvent();return this},ui:{mainBox:".bs_school_selector_main",searchTxt:".sl_search_box input",searchBtn:".sl_search_box .btn_s",provBtn:".prov_box .prov_list_item",radioBtn:".school_list_item input[type='radio']",currentProv:".prov_current",manualBtn:".manual_box a.manual_add",manualBtnOk:".manual_box a.manual_add_ok",manualBtnCanc:".manual_box a.manual_add_cancel",manualAddTxt:".manual_box input",manualBoxHolder:".manual_box",closeBtn:".bs_comp_close"},parseData:function(){this.pData.data=this.oriData;return this},templateBox:_.template(['<div class="bs_school_selector_main">','<h3><span class="bs_comp_title">选择学校</span> <span class="bs_comp_close">&nbsp;</span></h3>','<p id="loadingtext" style="padding:20px">数据加载中...</p>','<div id="mainContent" style="display:none;">','<div class="sl_search_box"><input type="text" value="" class="ipt_df" /><span class="btn_s"></span></div>','<div class="prov_box"></div>','<div class="school_box"></div>','<div class="bs_cb"></div>','<div class="manual_box">','<span>没有找到目标院校？</span> <a href="javascript:void(0)" class="manual_add">手动添加</a>','<span style="display:none;" class="btn_m_add"><input type="text" value="" class="" maxlength="100"/> &nbsp; &nbsp; <a href="javascript:void(0)" class="manual_add_ok">确定</a> &nbsp;<a href="javascript:void(0)" class="manual_add_cancel">取消</a></span>',"</div>","</div>","<div></div>","</div>"].join("")),tmplLoc:_.template(['<ul class="">',"<% _.each(data,function(item){ %>",'<li itemid="<%=item.id%>" class="prov_list_item"><%=item.district%></li>',"<% }) %>","</ul>"].join("")),tmplSchool:_.template(['<ul class="school_list_item">',"<% _.each(data.schools,function(item){ %>",'<li class="school_list_item">','<input type="<%=type=="multi" ? "checkbox": "radio" %>" name="abc"  itemid="<%=item.id%>"/>',"<label><%=item.name%></label></li>","<% }) %>","</ul>",'<%= data.schools.length==0 ? "<p>未搜索到相关学校！您可以手动添加学校。</p>" : ""%>'].join("")),toDomTree:function(){this.topBody.append(this.$el);return this},showProvince:function(id){var opts=this.pData.options;opts.activeProvince=id||opts.defaultProvince;this.$provCtt.html(this.tmplLoc(this.pData));return this},showDefault:function(){var self=this;if(typeof window.schoolDataV2!="undefined"){this.oriData=schoolDataV2;this.$el.find("#loadingtext").hide();this.$el.find("#mainContent").show();this.parseData().showProvince();this.$provCtt.find("li.prov_list_item[itemid='"+this.pData.options.defaultProvince+"']").trigger("click");this.initIptVal();this.initLengthLimit();this.showMask()}else{var self=this,rootURL=this.winTop.BSGlobal?this.winTop.BSGlobal.TenantId?this.winTop.$bs_vars.constSite:this.winTop.BSGlobal.constSite:"//const.italent.cn",tenantId=this.winTop.BSGlobal?this.winTop.BSGlobal.TenantId?this.winTop.BSGlobal.TenantId:this.winTop.BSGlobal.generalData.CurrentTenant.ID:"-";settingsURL=rootURL+"/api/setting/"+tenantId;function getJSONPData(url,callback,success){$.ajax({url:url,dataType:"jsonp",jsonpCallback:callback,cache:true,success:success})}getJSONPData(settingsURL,"talentData_settingsCallback",function(settings){getJSONPData(rootURL+"/api/compatible/SchoolsValueFormat/"+tenantId+"/"+settings.Version,"talent_schoolDataCallback",function(schools){window.schoolDataV2=schools;self.oriData=window.schoolDataV2;self.$el.find("#loadingtext").hide();self.$el.find("#mainContent").show();self.parseData().showProvince();self.$provCtt.find("li.prov_list_item[itemid='"+self.pData.options.defaultProvince+"']").trigger("click");self.initIptVal();self.initLengthLimit();self.showMask()})})}return this},bindEvent:function(){this.$el.delegate(this.ui.provBtn,"click",_.bind(this.activeProv,this));this.$el.delegate(this.ui.radioBtn,"click",_.bind(this.selectSchool,this));this.$el.delegate(this.ui.searchBtn,"click",_.bind(this.searchSchool,this));this.$el.delegate(this.ui.manualBtn,"click",_.bind(this.showManualAdd,this));this.$el.delegate(this.ui.manualBtnOk,"click",_.bind(this.manualAdd,this));this.$el.delegate(this.ui.manualBtnCanc,"click",_.bind(this.hideManualAdd,this));this.$el.delegate(this.ui.closeBtn,"click",_.bind(this.close,this));this.$el.find(this.ui.searchTxt).bind("focus",_.bind(this.iptFocus,this));this.$el.find(this.ui.searchTxt).bind("blur",_.bind(this.iptBlur,this));this.$el.delegate(this.ui.searchTxt,"keypress",_.bind(this.enterThenSearch,this));return this},initIptVal:function(){var ipt=this.$el.find(this.ui.searchTxt);this.hoster.blur();ipt.addClass("ipt_df").val(this.dfSearch)},initLengthLimit:function(){var ipt=this.$el.find(this.ui.manualAddTxt);ipt.unbind("keypress").bind("keypress",function(){if(ipt.val().length>=100)return false});ipt.get(0).onpropertychange=function(){var v=ipt.val();v.length>100&&setTimeout(function(){ipt.val(v.substring(0,100))},10)}},showMask:function(){this.mask=$('<div style="opacity: 0.5; filter:alpha(opacity=50); height: 100%; width: 100%; position: fixed; left: 0px; top: 0px; z-index: 990; background-color: black;"></div>');this.topBody.append(this.mask)},iptFocus:function(e){var ipt=$(e.currentTarget);ipt.is(".ipt_df")&&ipt.removeClass("ipt_df").val("")},iptBlur:function(e){var ipt=$(e.currentTarget);$.trim(ipt.val())==""&&ipt.addClass("ipt_df").val(this.dfSearch)},activeProv:function(e){var self=this,node=$(e.currentTarget);this.pData.options.activeProvince=node.attr("itemid");this.$el.find(this.ui.currentProv).removeClass("prov_current");node.addClass("prov_current");return this.showSchools(_.find(this.pData.data,function(item){return item.id==self.pData.options.activeProvince}))},showSchools:function(sdata){this.$schCtt.html(this.tmplSchool({data:sdata,type:this.pData.options.type}));return this},enterThenSearch:function(e){var c=e.keyCode;c==13&&this.searchSchool()},selectSchool:function(e){var node=$(e.currentTarget),selectedData={id:node.attr("itemid"),name:node.next().text()};this.hoster.val(selectedData.name);return this.close()},searchSchool:function(){var ipt=this.$el.find(this.ui.searchTxt);if(ipt.is(".ipt_df"))return;var v=$.trim(this.getSearchVal());if(!v)return;this.$el.find(this.ui.currentProv).removeClass("prov_current");var allSchool=_.flatten(_.map(this.pData.data,function(item){return item.schools}));return this.showSchools({schools:_.filter(allSchool,function(item){return item.name.indexOf(v)!=-1})})},getSearchVal:function(){return this.$el.find(this.ui.searchTxt).val()},showManualAdd:function(e){var node=$(e.currentTarget);node.hide();node.next().show();return this},manualAdd:function(){var v=this.$el.find(this.ui.manualAddTxt).val();this.hoster.val(v);return this.hideManualAdd().close()},hideManualAdd:function(){this.$el.find(this.ui.manualAddTxt).val("");this.$el.find(this.ui.manualBtn).show();this.$el.find(this.ui.manualBtnOk).parent().hide();return this},close:function(){this.$el.hide();this.mask.remove();return this},displayManualAdd:function(){this.$el.find(this.ui.manualBoxHolder).hide()}};$.fn.extend({schoolSelector:function(data,opt){var self=this,defaults={defaultProvince:"1100",activeProvince:"1100",type:"single"};opt=opt||{};var options=$.extend({},defaults,opt),customDenyManualAddIDs=[],customDenyManualDomains=["haixin.zhiye.com","hisense.zhiye.com"];if(BSGlobal&&BSGlobal.generalData&&BSGlobal.generalData.CurrentTenant&&BSGlobal.generalData.CurrentTenant.ID&&_.contains(customDenyManualAddIDs,BSGlobal.generalData.CurrentTenant.ID))options.denyManualAdd=true;if(_.contains(customDenyManualDomains,window.location.hostname))options.denyManualAdd=true;var isl=new SchoolSelector(options,data,this);isl.toDomTree();self.click(function(){isl.showDefault().$el.show()})}})}).call(this,jQuery,_)
